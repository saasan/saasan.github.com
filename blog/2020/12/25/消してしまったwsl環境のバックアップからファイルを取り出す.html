<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <title>消してしまった WSL 環境のバックアップからファイルを取り出す</title>
    <link href='//fonts.googleapis.com/css?family=Orbitron:500' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="https://saasan.github.io/blog/2020/12/25/%E6%B6%88%E3%81%97%E3%81%A6%E3%81%97%E3%81%BE%E3%81%A3%E3%81%9Fwsl%E7%92%B0%E5%A2%83%E3%81%AE%E3%83%90%E3%83%83%E3%82%AF%E3%82%A2%E3%83%83%E3%83%97%E3%81%8B%E3%82%89%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E5%8F%96%E3%82%8A%E5%87%BA%E3%81%99.html">
    <link rel="alternate" type="application/rss+xml" title="saasan.github.io" href="https://saasan.github.io/feed.xml" />
    <link rel="apple-touch-icon" href="https://saasan.github.io/img/s2works_favicon.png">
    <script data-ad-client="ca-pub-0141905477316976" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@saasan">
    <meta property="og:url" content="https://saasan.github.io/blog/2020/12/25/%E6%B6%88%E3%81%97%E3%81%A6%E3%81%97%E3%81%BE%E3%81%A3%E3%81%9Fwsl%E7%92%B0%E5%A2%83%E3%81%AE%E3%83%90%E3%83%83%E3%82%AF%E3%82%A2%E3%83%83%E3%83%97%E3%81%8B%E3%82%89%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E5%8F%96%E3%82%8A%E5%87%BA%E3%81%99.html">
    <meta property="og:title" content="消してしまった WSL 環境のバックアップからファイルを取り出す">
    <meta property="og:description" content="PCを移行する際にWSL環境のことを忘れていた。旧PCのバックアップファイルからWSLのUbuntu内にあるファイルを取り出したい。">
    <meta property="og:image" content="https://saasan.github.io/img/s2works_favicon.png">
    <script type="application/ld+json">
      {
        "@context": "http://schema.org/",
        "@type": "Person",
        "name": "saasan",
        "sameAs": [
          "https://twitter.com/saasan",
          "https://github.com/saasan"
        ]
      }
    </script>
    <script type="application/ld+json">
      {
        "@context": "http://schema.org",
        "@type": "Article",
        "name": "消してしまった WSL 環境のバックアップからファイルを取り出す",
        "datePublished": "2020-12-25T22:44:17+09:00",
        "headline": "PCを移行する際にWSL環境のことを忘れていた。旧PCのバックアップファイルからWSLのUbuntu内にあるファイルを取り出したい。",
        "image": "https://saasan.github.io/img/s2works_favicon.png",
        "url": "https://saasan.github.io/blog/2020/12/25/%E6%B6%88%E3%81%97%E3%81%A6%E3%81%97%E3%81%BE%E3%81%A3%E3%81%9Fwsl%E7%92%B0%E5%A2%83%E3%81%AE%E3%83%90%E3%83%83%E3%82%AF%E3%82%A2%E3%83%83%E3%83%97%E3%81%8B%E3%82%89%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%92%E5%8F%96%E3%82%8A%E5%87%BA%E3%81%99.html",
        "publisher" : {
          "@type": "Person",
          "name": "saasan"
        }
      }
    </script>
  </head>
  <body itemscope itemtype="http://schema.org/WebPage">
    <header class="site-header">
      <div class="wrapper">
        <a class="site-title" href="/">saasan.github.io</a>
        <nav class="site-nav">
          <div class="site-nav-contents">
            <ul>
              <li><a href="/blog/">ブログ</a></li>
              <li><a href="/imas/">アイマス</a></li>
              <li><a href="/software/">ソフトウェア</a></li>
              <li><a href="/script/">スクリプト</a></li>
            </ul>
          </div>
        </nav>
      </div>
    </header>
    <div class="page-content">
      <div class="wrapper">
        <div class="post" itemprop="mainContentOfPage" itemscope itemtype="http://schema.org/WebPageElement">
          <header class="post-header">
            <h1 class="post-title">消してしまった WSL 環境のバックアップからファイルを取り出す</h1>
            <div class="post-meta">
              <time datetime="2020-12-25T22:44:17+09:00" itemprop="dateModified">2020/12/25</time>
            </div>
          </header>
          <article class="post-content">
            <p>PC を新しいものへ移行する際に WSL 環境の中身を移行するのを忘れていた。
              というか、別の環境に最新のファイルがあると思い込んでいたので敢えて移行しなかったのだ。
              実際は自分の旧 PC の WSL 環境にあったものが最新のファイルで、
              それに気付いたときにはディスクの初期化が済んでいた。</p>
            <p>旧 PC の Ubuntu 内には作業中のファイルがあり、
              これが消えてしまうと10時間ほどかけた作業が無駄になってしまう。
              こんなこともあろうかと、旧 PC のディスクを
              <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/disk2vhd">Disk2vhd</a>
              で VHDX ファイル化したものは残しておいたので、
              このバックアップファイルから必要なファイルを取り出すことにした。</p>
            <h2 id="旧-pc-のバックアップから-ubuntu-のディスクイメージを探す">旧 PC のバックアップから Ubuntu のディスクイメージを探す</h2>
            <p>まずは旧 PC のバックアップから Ubuntu のディスクイメージを探す。
              VHDX ファイルをダブルクリックすると自動でマウントされるので
              その中を探したところ以下のパスにディスクイメージがあった。</p>
            <blockquote>
              <p>\Users\ユーザー名\AppData\Local\Packages\CanonicalGroupLimited.UbuntuonWindows_79rhkp1fndgsc\LocalState\ext4.vhdx</p>
            </blockquote>
            <p>このファイルをマウントして中身を取り出して完了かと思ったら、
              ファル名通りファイルシステムが ext4 だからなのか
              Windows ではマウントできなかった。</p>
            <p>しかたないので新 PC の WSL へ新しいディストリビューションを入れて
              ext4.vhdx を置き換えることにする。</p>
            <h2 id="alpine-wsl-をインストールする">Alpine WSL をインストールする</h2>
            <p>ext4.vhdx からファイルを取り出すため
              <a href="https://www.microsoft.com/ja-jp/p/alpine-wsl/9p804crf0395?activetab=pivot:overviewtab">Alpine WSL</a>
              をインストールした。
              これはおそらく新 PC で使ってないディストリビューションならなんでもいい。
              新 PC でも既に Ubuntu を使い始めていたのでそれ以外で、
              インストール作業に時間をかけたくないこともあり
              軽量なことで有名な Alpine Linux を選択した。</p>
            <p>インストール後、念のため一度起動して初期設定を行っておく。</p>
            <h2 id="wsl-のサービスを停止して-ext4vhdx-を置き換える">WSL のサービスを停止して ext4.vhdx を置き換える</h2>
            <p>WSL のサービスが起動したままだとファイルがロックされていて置き換えられない。
              コマンドプロンプトか PowerShell を管理者権限で起動し、
              以下のコマンドで WSL のサービスを止める。</p>
            <div class="language-plaintext highlighter-rouge">
              <div class="highlight">
                <pre class="highlight"><code>net stop LxssManager
</code></pre>
              </div>
            </div>
            <p>次に以下のパスにある Alpine WSL の ext4.vhdx
              を旧 PC のバックアップから取り出したもので置き換える。</p>
            <blockquote>
              <p>\Users\ユーザー名\AppData\Local\Packages\36828agowa338.AlpineWSL_my43bytk1c4nr\LocalState\ext4.vhdx</p>
            </blockquote>
            <p>最後に以下のコマンドで WSL のサービスを起動する。</p>
            <div class="language-plaintext highlighter-rouge">
              <div class="highlight">
                <pre class="highlight"><code>net start LxssManager
</code></pre>
              </div>
            </div>
            <h2 id="必要なファイルを取り出す">必要なファイルを取り出す</h2>
            <p>あとは alpine コマンドで起動し旧 PC の
              Ubuntu 環境へ入ってファイルを取り出すことができた。</p>
          </article>
        </div>
      </div>
    </div>
    <footer class="site-footer">
      <div class="wrapper">
        <nav>
          <ul>
            <li><a href="/blog/">ブログ</a></li>
            <li><a href="/imas/">アイマス</a></li>
            <li><a href="/software/">ソフトウェア</a></li>
            <li><a href="/script/">スクリプト</a></li>
          </ul>
          <a href="https://twitter.com/saasan" target="_blank" class="twitter-username">
            saasan
          </a>
          <a href="/feed.xml" target="_blank" class="rss">RSS</a>
        </nav>
      </div>
    </footer>
  </body>
</html>